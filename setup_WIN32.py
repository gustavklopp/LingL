from cx_Freeze import setup, Executable
import os


# delete the previous database:
db_path = 'lwt/LingL_database.sqlite3'
if os.path.exists(db_path):
    os.remove(db_path)

# first creating the database and populate it
os.system('python manage.py migrate')
os.system('python manage.py loaddata  initial_fixture_USER.yaml')
os.system('python manage.py loaddata  initial_fixture_LANGUAGES.yaml')

cwd = os.getcwd()
lingl_image_path = os.path.join(cwd,'LingL','lwt','static','lwt','img','site_icon_16x16.png') # Dependencies are automatically detected, but it might need # fine tuning.
buildOptions = dict(
        packages = [
            'builtins',
            'sys',
#             '_frozen_importlib',
            '_imp',
            '_warnings',
            '_thread',
            '_weakref',
#             '_frozen_importlib_external',
            '_io',
            'marshal',
            #'posix',
            'zipimport',
            'encodings',
            'codecs',
            '_codecs',
            'encodings.aliases',
            'encodings.utf_8',
            '_signal',
#             '__main__',
            'encodings.latin_1',
            'io',
            'abc',
            '_weakrefset',
            'site',
            'os',
            'errno',
            'stat',
            '_stat',
            'posixpath',
            'genericpath',
#             'os.path',
            '_collections_abc',
            '_bootlocale',
            '_locale',
#             'sitecustomize',
            'getpass',
            'contextlib',
            'collections',
            'operator',
            '_operator',
            'keyword',
            'heapq',
            '_heapq',
            'itertools',
            'reprlib',
            '_collections',
            'functools',
            '_functools',
            'types',
            'collections.abc',
            'weakref',
            'warnings',
            #'termios',
            'django',
            '__future__',
            'django.utils',
            'django.utils.version',
            'datetime',
            'time',
            'math',
            '_datetime',
            'subprocess',
            'signal',
            'enum',
            #'_posixsubprocess',
            'select',
            'selectors',
            'threading',
            'traceback',
            'linecache',
            'tokenize',
            're',
            'sre_compile',
            '_sre',
            'sre_parse',
            'sre_constants',
            'copyreg',
            'token',
#             'django.utils.lru_cache',
            'django.core',
            'django.core.management',
            'pkgutil',
            'importlib',
            'importlib._bootstrap',
            'importlib._bootstrap_external',
            'importlib.util',
            'importlib.abc',
            'importlib.machinery',
            'django.apps',
            'django.apps.config',
            'django.core.exceptions',
#             'django.utils.six',
            'struct',
            '_struct',
            'django.utils.encoding',
            'locale',
            'decimal',
            '_pydecimal',
            'numbers',
            'django.utils.functional',
            'copy',
            'django.utils.deprecation',
            'inspect',
            'ast',
            '_ast',
            'dis',
            'opcode',
            '_opcode',
#             'django.utils.six.moves',
#             'django.utils.six.moves.urllib',
#             'django.utils.six.moves.urllib.parse',
            'urllib',
            'urllib.parse',
            'django.utils._os',
            'tempfile',
            'shutil',
            'fnmatch',
            'zlib',
            'bz2',
            '_compression',
            '_bz2',
            'lzma',
            '_lzma',
            #'pwd',
            #'grp',
            'random',
            'hashlib',
            '_hashlib',
            '_blake2',
            '_sha3',
            'bisect',
            '_bisect',
            '_random',
            'django.utils.module_loading',
            'django.apps.registry',
            'django.conf',
            'django.conf.global_settings',
            'django.core.management.base',
            'argparse',
            'textwrap',
            'gettext',
            'django.core.checks',
            'django.core.checks.messages',
            'django.core.checks.registry',
            'django.utils.itercompat',
            'django.core.checks.caches',
            'django.core.cache',
            'django.core.signals',
            'django.dispatch',
            'django.dispatch.dispatcher',
            'django.utils.inspect',
            'django.core.cache.backends',
            'django.core.cache.backends.base',
            'atexit',
            'django.core.checks.compatibility',
#             'django.core.checks.compatibility.django_1_8_0',
#             'django.core.checks.compatibility.django_1_10',
            'django.core.checks.database',
            'django.db',
            'django.db.utils',
            'django.core.checks.model_checks',
            'django.core.checks.security',
            'django.core.checks.security.base',
#             'django.core.checks.utils',
            'django.core.checks.security.csrf',
            'django.core.checks.security.sessions',
            'django.core.checks.templates',
            'django.core.checks.urls',
            'django.core.management.color',
            'django.utils.termcolors',
            'django.db.migrations',
            'django.db.migrations.migration',
            'django.db.transaction',
            'django.utils.decorators',
            'django.db.migrations.exceptions',
            'django.db.migrations.operations',
            'django.db.migrations.operations.fields',
            'django.db.models',
            'django.db.models.signals',
            'django.db.models.utils',
            'django.db.models.aggregates',
            'django.db.models.expressions',
            'django.db.backends',
            'django.db.backends.utils',
            'logging',
            'string',
            '_string',
            'django.utils.timezone',
            'pytz',
            'pytz.exceptions',
            'pytz.lazy',
            'pytz.tzinfo',
            'pytz.tzfile',
            'django.db.models.fields',
            'uuid',
            'ctypes',
            '_ctypes',
            'ctypes._endian',
            'ctypes.util',
            'base64',
            'binascii',
            'django.forms',
            'django.forms.boundfield',
            'django.forms.utils',
            'json',
            'json.decoder',
            'json.scanner',
            '_json',
            'json.encoder',
            'django.utils.html',
            'django.utils.http',
            'calendar',
            'unicodedata',
            'email',
            'email.utils',
            'socket',
            '_socket',
            'email._parseaddr',
            'email.charset',
            'email.base64mime',
            'email.quoprimime',
            'email.errors',
            'email.encoders',
            'quopri',
            'django.utils.datastructures',
            'django.utils.safestring',
            'django.utils.text',
            'gzip',
            'html',
            'html.entities',
            'django.utils.translation',
#             'django.utils.html_parser',
            'html.parser',
            '_markupbase',
            'django.forms.widgets',
            'django.templatetags',
            'django.templatetags.static',
            'django.template',
            'django.template.engine',
            'django.template.base',
            'django.template.context',
            'django.utils.formats',
            'django.utils.dateformat',
            'django.utils.dates',
            'django.utils.datetime_safe',
            'django.utils.numberformat',
            'django.template.exceptions',
            'django.template.library',
            'django.template.utils',
            'django.forms.renderers',
            'django.template.backends',
            'django.template.backends.django',
            'django.template.backends.base',
            'django.template.loader',
            'django.forms.fields',
            'django.core.validators',
            'django.utils.deconstruct',
            'django.utils.ipv6',
            'django.utils.dateparse',
            'django.utils.duration',
            'django.forms.forms',
            'django.forms.formsets',
            'django.forms.models',
            'django.db.models.constants',
            'django.db.models.query_utils',
            'django.utils.tree',
            'django.db.models.deletion',
            'django.db.models.sql',
            'django.db.models.sql.query',
            'django.db.models.fields.related_lookups',
            'django.db.models.lookups',
            'django.db.models.sql.constants',
            'django.db.models.sql.datastructures',
            'django.db.models.sql.where',
            'django.db.models.sql.subqueries',
            'django.db.models.fields.files',
            'django.core.files',
            'django.core.files.base',
            'django.core.files.utils',
            'django.core.files.images',
            'django.core.files.storage',
            'django.core.files.locks',
            #'fcntl',
            'django.core.files.move',
            'django.utils.crypto',
            'hmac',
            'django.db.models.fields.proxy',
            'django.db.models.indexes',
            'django.db.models.manager',
            'django.db.models.query',
            'django.db.models.functions',
#             'django.db.models.functions.base',
            'django.db.models.functions.datetime',
            'django.db.models.base',
            'django.db.models.fields.related',
            'django.db.models.fields.related_descriptors',
            'django.db.models.fields.reverse_related',
            'django.db.models.options',
            'django.db.migrations.operations.base',
            'django.db.migrations.operations.models',
            'django.db.migrations.state',
            'django.db.migrations.operations.special',
            'django.utils.autoreload',
            'LingL',
            'LingL.settings',
            'django.shortcuts',
            'django.http',
            'django.http.cookie',
            'http',
            'http.cookies',
            'django.http.request',
            'django.core.signing',
            'django.utils.baseconv',
            'django.core.files.uploadhandler',
            'django.core.files.uploadedfile',
            'django.core.files.temp',
            'django.http.multipartparser',
            'cgi',
            'email.parser',
            'email.feedparser',
            'email._policybase',
            'email.header',
            'email.message',
            'uu',
            'email._encoded_words',
            'email.iterators',
            'django.http.response',
            'django.core.serializers',
            'django.core.serializers.base',
            'django.core.serializers.json',
            'django.core.serializers.python',
            'http.client',
            'ssl',
            'ipaddress',
            '_ssl',
#             'django.utils.six.moves.http_client',
            'django.urls',
            'django.urls.base',
            'django.urls.exceptions',
            'django.urls.resolvers',
            'django.utils.regex_helper',
            'django.urls.utils',
            'django.contrib',
            'django.contrib.messages',
            'django.contrib.messages.api',
            'django.contrib.messages.constants',
            'django.contrib.messages.storage',
            'django.utils.log',
            'logging.config',
            'logging.handlers',
            'pickle',
            '_compat_pickle',
            '_pickle',
            'queue',
            'socketserver',
            'django.core.mail',
            'django.core.mail.message',
            'mimetypes',
            'email.generator',
            'email.mime',
            'email.mime.base',
            'email.policy',
            'email.headerregistry',
            'email._header_value_parser',
            'email.contentmanager',
            'email.mime.message',
            'email.mime.nonmultipart',
            'email.mime.multipart',
            'email.mime.text',
            'django.core.mail.utils',
            'django.views',
            'django.views.generic',
            'django.views.generic.base',
            'django.template.response',
            'django.views.generic.dates',
            'django.views.generic.detail',
            'django.views.generic.list',
            'django.core.paginator',
            'django.views.generic.edit',
            'django.views.debug',
            'django.template.defaultfilters',
            'pprint',
            'django.utils.timesince',
            'django.template.defaulttags',
            'django.utils.lorem_ipsum',
            'django.template.smartif',
            'django.template.loader_tags',
            'django.contrib.admin',
            'django.contrib.admin.decorators',
            'django.contrib.admin.filters',
            'django.contrib.admin.options',
            'django.contrib.admin.helpers',
            'django.contrib.admin.utils',
            'django.contrib.auth',
            'django.middleware',
            'django.middleware.csrf',
            'django.utils.cache',
            'django.contrib.auth.signals',
            'django.contrib.admin.widgets',
            'django.contrib.admin.checks',
            'django.contrib.admin.exceptions',
            'django.contrib.admin.templatetags',
            'django.contrib.admin.templatetags.admin_urls',
            'django.views.decorators',
            'django.views.decorators.csrf',
            'django.contrib.admin.sites',
            'django.contrib.admin.actions',
            'django.views.decorators.cache',
            'django.middleware.cache',
            'django.views.i18n',
            'django.utils.translation.trans_real',
            'django.conf.locale',
            'django.contrib.admin.apps',
            'django.contrib.auth.apps',
            'django.contrib.auth.checks',
            'django.contrib.auth.management',
            'django.contrib.contenttypes',
            'django.contrib.contenttypes.apps',
            'django.contrib.contenttypes.checks',
            'django.contrib.contenttypes.management',
            'django.contrib.sessions',
            'django.contrib.sessions.apps',
            'django.contrib.messages.apps',
            'django.contrib.staticfiles',
            'django.contrib.staticfiles.apps',
            'django.contrib.sites',
            'django.contrib.sites.apps',
            'django.contrib.sites.management',
            'lwt',
            'tags_input',
            'mathfilters',
            'allauth',
            'allauth.account',
            'allauth.account.apps',
            'allauth.socialaccount',
            'allauth.socialaccount.apps',
            'crispy_forms',
            'django.contrib.admin.models',
            'django.contrib.contenttypes.models',
            'django.contrib.auth.models',
            'django.contrib.auth.base_user',
            'django.contrib.auth.password_validation',
            'difflib',
            'django.contrib.auth.hashers',
            'django.db.backends.sqlite3',
            'django.db.backends.sqlite3.base',
            'django.db.backends.base',
            'django.db.backends.base.base',
            'django.db.backends.base.validation',
            'django.db.backends.signals',
            'sqlite3',
            'sqlite3.dbapi2',
            '_sqlite3',
            'django.db.backends.sqlite3.client',
            'django.db.backends.base.client',
            'django.db.backends.sqlite3.creation',
            'django.db.backends.base.creation',
            'django.db.backends.sqlite3.features',
            'django.db.backends.base.features',
            'django.db.backends.sqlite3.introspection',
            'django.db.backends.base.introspection',
            'django.db.backends.sqlite3.operations',
            'django.db.backends.base.operations',
            'django.db.backends.sqlite3.schema',
            'django.db.backends.base.schema',
            'django.contrib.auth.validators',
            'django.contrib.sessions.models',
            'django.contrib.sessions.base_session',
            'django.contrib.sites.models',
            'lwt.models',
            'allauth.account.adapter',
            'django.contrib.sites.shortcuts',
            'allauth.account.app_settings',
#             'allauth.compat',
            'allauth.utils',
            'lwt.constants',
            'allauth.models',
            'allauth.account.models',
            'allauth.account.signals',
            'allauth.app_settings',
            'allauth.account.managers',
            'allauth.account.utils',
            'allauth.exceptions',
            'allauth.socialaccount.models',
            'allauth.socialaccount.app_settings',
            'allauth.socialaccount.providers',
            'allauth.socialaccount.adapter',
            'allauth.socialaccount.fields',
            'django.contrib.auth.admin',
            'django.conf.urls',
            'django.contrib.auth.forms',
            'django.contrib.auth.tokens',
            'django.views.decorators.debug',
            'django.contrib.contenttypes.admin',
            'django.contrib.contenttypes.fields',
            'django.contrib.contenttypes.forms',
            'django.contrib.sites.admin',
            'lwt.admin',
            'tags_input.admin',
            'tags_input.fields',
            'tags_input.widgets',
            'six',
#             'django.core.urlresolvers',
            'tags_input.utils',
            'tags_input.exceptions',
            'allauth.account.admin',
            'allauth.socialaccount.admin',
            'django.contrib.staticfiles.management',
            'django.contrib.staticfiles.management.commands',
            'django.contrib.staticfiles.management.commands.runserver',
            'django.contrib.staticfiles.handlers',
            'django.contrib.staticfiles.utils',
            'django.contrib.staticfiles.views',
            'django.contrib.staticfiles.finders',
            'django.views.static',
            'django.core.handlers',
            'django.core.handlers.wsgi',
            'django.core.handlers.base',
            'django.core.handlers.exception',
#             'django.utils.six.moves.urllib.request',
            'urllib.request',
            'urllib.error',
            'urllib.response',
            'django.core.management.commands',
            'django.core.management.commands.runserver',
            'django.core.servers',
            'django.core.servers.basehttp',
            'wsgiref',
            'wsgiref.simple_server',
            'http.server',
            'wsgiref.handlers',
            'wsgiref.util',
            'wsgiref.headers',
            'platform',
            'django.core.wsgi',
            'LingL.urls',
            'django.conf.urls.static',
            'lwt.views',
            'lwt.views.homepage',
            'django.templatetags.i18n',
            'django.contrib.auth.decorators',
            'lwt.forms',
            'crispy_forms.helper',
#             'crispy_forms.compatibility',
            'crispy_forms.exceptions',
            'crispy_forms.layout',
            'crispy_forms.utils',
            'crispy_forms.base',
            'crispy_forms.layout_slice',
            'crispy_forms.bootstrap',
            'allauth.account.forms',
            'splitjson',
            'splitjson.fields',
            'splitjson.widgets',
            'lwt.views._setting_cookie_db',
            'lwt.views.language',
            'lwt.views.text',
#             'django.contrib.staticfiles.templatetags',
#             'django.contrib.staticfiles.templatetags.staticfiles',
            'lwt.views._utilities_views',
            'lwt.views._nolang_redirect_decorator',
            'lwt.views.text_read',
            'lwt.views.termform',
            'lwt.views.term',
            'lwt.views.term_list',
            'lwt.views.backuprestore',
            'lwt.views._import_oldlwt',
            'lwt.views.statistics',
            'lwt.views.export2anki_exporter',
            'django.contrib.contenttypes.views',
            'django.contrib.sites.requests',
            'tags_input.urls',
            'tags_input.views',
            'allauth.urls',
            'allauth.account.urls',
            'allauth.account.views',
            'allauth.socialaccount.urls',
            'allauth.socialaccount.views',
            'allauth.socialaccount.helpers',
            'allauth.socialaccount.signals',
            'allauth.socialaccount.providers.base',
            'allauth.socialaccount.forms',
            'django.templatetags.cache',
            'django.core.cache.utils',
            'django.templatetags.l10n',
            'django.templatetags.tz',
#             'django.contrib.admin.templatetags.admin_list',
            'django.contrib.admin.views',
            'django.contrib.admin.views.main',
#             'django.contrib.admin.templatetags.admin_modify',
#             'django.contrib.admin.templatetags.admin_static',
#             'django.contrib.admin.templatetags.log',
            'lwt.templatetags',
            'lwt.templatetags.debug',
            'pdb',
            'cmd',
            'bdb',
            'code',
            'codeop',
            'glob',
            'lwt.templatetags.djangoversion',
            'lwt.templatetags.pythonversion',
            'lwt.templatetags.range',
            'mathfilters.templatetags',
            'mathfilters.templatetags.mathfilters',
            'allauth.account.templatetags',
            'allauth.account.templatetags.account',
            'allauth.socialaccount.templatetags',
            'allauth.socialaccount.templatetags.socialaccount',
            'crispy_forms.templatetags',
            'crispy_forms.templatetags.crispy_forms_field',
            'crispy_forms.templatetags.crispy_forms_filters',
            'crispy_forms.templatetags.crispy_forms_tags',
            'crispy_forms.templatetags.crispy_forms_utils',
            'django.db.migrations.executor',
            'django.db.migrations.loader',
            'django.db.migrations.graph',
            'django.db.migrations.recorder',
            'django.contrib.admin.migrations',
            'django.contrib.admin.migrations.0002_logentry_remove_auto_add',
            'django.contrib.admin.migrations.0001_initial',
            'django.contrib.auth.migrations',
            'django.contrib.auth.migrations.0002_alter_permission_name_max_length',
            'django.contrib.auth.migrations.0006_require_contenttypes_0002',
            'django.contrib.auth.migrations.0007_alter_validators_add_error_messages',
            'django.contrib.auth.migrations.0008_alter_user_username_max_length',
            'django.contrib.auth.migrations.0005_alter_user_last_login_null',
            'django.contrib.auth.migrations.0001_initial',
            'django.contrib.auth.migrations.0003_alter_user_email_max_length',
            'django.contrib.auth.migrations.0004_alter_user_username_opts',
            'django.contrib.contenttypes.migrations',
            'django.contrib.contenttypes.migrations.0001_initial',
            'django.contrib.contenttypes.migrations.0002_remove_content_type_name',
            'django.contrib.sessions.migrations',
            'django.contrib.sessions.migrations.0001_initial',
            'django.contrib.sites.migrations',
            'django.contrib.sites.migrations.0002_alter_domain_unique',
            'django.contrib.sites.migrations.0001_initial',
            'lwt.migrations',
#             'lwt.migrations.0020_texts_archived_txt',
#             'lwt.migrations.0010_auto_20171113_2130',
#             'lwt.migrations.0001_initial',
#             'lwt.migrations.0023_remove_texts_archived_txt',
#             'lwt.migrations.0002_auto_20171108_1355',
#             'lwt.migrations.0016_auto_20171126_1325',
#             'lwt.migrations.0007_auto_20171110_1124',
#             'lwt.migrations.0021_languages_extra_field_key',
#             'lwt.migrations.0015_words_export2anki',
#             'lwt.migrations.0009_auto_20171113_2130',
#             'lwt.migrations.0004_auto_20171109_1924',
#             'lwt.migrations.0022_auto_20171203_1931',
#             'lwt.migrations.0017_auto_20171129_1603',
#             'lwt.migrations.0012_settings_selected_words',
#             'lwt.migrations.0006_auto_20171109_2113',
#             'lwt.migrations.0003_auto_20171108_2042',
#             'lwt.migrations.0013_auto_20171126_1128',
#             'lwt.migrations.0005_auto_20171109_2019',
#             'lwt.migrations.0014_auto_20171126_1129',
#             'lwt.migrations.0018_words_extra_field',
#             'lwt.migrations.0008_texts_lastopentime',
#             'lwt.migrations.0019_auto_20171202_1319',
#             'lwt.migrations.0011_settings_currentfilter_text_settings_currentfilter_word',
            'allauth.account.migrations',
            'allauth.account.migrations.0002_email_max_length',
            'allauth.account.migrations.0001_initial',
            'allauth.socialaccount.migrations',
            'allauth.socialaccount.migrations.0002_token_max_lengths',
            'allauth.socialaccount.migrations.0003_extra_data_default_dict',
            'allauth.socialaccount.migrations.0001_initial',
            'django.db.models.sql.compiler',
            'LingL.wsgi',
            'django.middleware.clickjacking',
            'django.contrib.messages.middleware',
            'django.contrib.auth.middleware',
            'django.contrib.auth.backends',
            'django.middleware.common',
            'django.contrib.sessions.middleware',
            'django.contrib.sessions.backends',
            'django.contrib.sessions.backends.base',
            'django.contrib.sessions.exceptions',
            'django.contrib.sessions.backends.db',
            'django.middleware.security',
            'encodings.idna',
            'stringprep',
            'django.contrib.sessions.serializers',
            'django.contrib.messages.storage.fallback',
            'django.contrib.messages.storage.base',
            'django.contrib.messages.utils',
            'django.contrib.messages.storage.cookie',
            'django.contrib.messages.storage.session',
            'django.contrib.auth.views',
            'django.template.loaders',
            'django.template.loaders.filesystem',
            'django.template.loaders.base',
            'django.template.loaders.app_directories',
            'django.template.context_processors',
            'django.contrib.auth.context_processors',
            'django.contrib.messages.context_processors',
            'django.contrib.staticfiles.storage',
            'django.conf.locale.en',
            'django.conf.locale.en.formats',
            'django.core.cache.backends.locmem',
#             'django.utils.synch',
            'allauth.account.auth_backends',
#             'dj-static',
            'setuptools',
            'waitress',
            'wx',
            'fitz',
            ], 
        excludes = ['tkinter', 'Tkinter'],
        include_files = [
              'LingL_app.ico',
              'LingL_app.icns',
#             'appversion.txt',
#                 os.path.join('lwt', 'LingL_database.sqlite3'), #no need, it's automatically joined
#                 os.path.join('templates','allauth'),
                ],
        )

import sys
base = 'Win32GUI' if sys.platform=='win32' else None

executables = [
    Executable('LingL_app.py', base=base,
        icon="LingL_app.ico", 
        target_name='LingLibre')
]

appversion = ''
appversiontxt_path = os.path.join(os.getcwd(), 'lwt','appversion.txt')
with open(appversiontxt_path, 'r', encoding="utf8") as appversion_f:
    appversion = appversion_f.read()

#NB: There's a bug with Python 3.8 on Windows: I've manually edited the locale.py file in Python itself
# because getlocale is getting 'en-US' instead of 'en_US'! (simple ....replace('-','_')

setup(name='LingL',
      version = appversion,
      description = 'learn languages by reading what you want!',
      options = dict(build_exe = buildOptions),
      executables = executables)
